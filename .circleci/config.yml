---
version: 2.1

orbs:
  python: circleci/python@2.0.3
  taskfile: threecomma/taskfile@0.1.0

jobs:
  test:
    # ToDo matrix
    docker: &job_docker_conf
      - image: cimg/python:3.9
    steps:
      - checkout
      # Running `setup.py` requires a `version` file, and the more or less
      # proper way to get that is to install avakas, though for testing this
      # feels better
      - run:
          name: "fake version file"
          command: "echo 'v0.0.0-testonly.0' > version"
      - python/install-packages:
          pkg-manager: "pip-dist"
      - python/install-packages:
          pkg-manager: pip
          pip-dependency-file: "requirements-dev.txt"
      - run:
          name: Run Tests
          command: make test

  build:
    docker: *job_docker_conf
    steps:
      - checkout
      - python/dist

workflows:
  dev:
    jobs:
      - test
      - build:
          requires:
            - test
