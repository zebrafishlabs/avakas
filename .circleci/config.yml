---
version: 2.1

orbs:
  python: circleci/python@2.0.3
  taskfile: threecomma/taskfile@0.1.0

jobs:
  get_version:
    docker: &job_docker_conf
      - image: cimg/python:3.8
    steps: &install_fake_version
      - run: &create_fake_version_file
          # Running `setup.py` requires a `version` file, and the more or less
          # proper way to get that is to install avakas, though for testing this
          # feels better
          name: fake a version file
          command: "echo 'v0.0.0-testonlysofake.0' > version"
      - python/install-packages: &install_setup_py
          pkg-manager: "pip-dist"
      - run:
          name: Get correct version
          command: avakas show . --flavor git-native
      - persist_to_workspace:
          root: .
          paths:
            - version


  test:
    # ToDo matrix
    docker: *job_docker_conf
    steps:
      - checkout
      - run: *create_fake_version_file
      - python/install-packages: *install_setup_py
      # install dev requirements for running tests
      - python/install-packages:
          pkg-manager: pip
          pip-dependency-file: "requirements-dev.txt"
      - run:
          name: Run Tests
          command: make test

  build:
    docker: *job_docker_conf
    steps:
      - checkout
      - python/dist

workflows:
  dev:
    jobs:
      - test
      - get_version
      - build:
          requires:
            - get_version
            - test
